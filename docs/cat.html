<!DOCTYPE html>

<html>
<head>
  <title>cat.rb</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="bill.html">
                bill.rb
              </a>
            
              
              <a class="source" href="cat.html">
                cat.rb
              </a>
            
              
              <a class="source" href="legislator.html">
                legislator.rb
              </a>
            
              
              <a class="source" href="organization.html">
                organization.rb
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>cat.rb</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Download this example’s <a href="https://raw.githubusercontent.com/opennorth/pupa-ruby/gh-pages/docs/cat.rb">Ruby code</a>
to run locally.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">require</span> <span class="hljs-string">'pupa'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Require Nokogiri to automatically parse HTML responses.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">require</span> <span class="hljs-string">'nokogiri'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cat</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>All models should mixin
<a href="https://github.com/opennorth/pupa-ruby/blob/master/lib/pupa/models/model.rb#files">Pupa::Model</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">include</span> <span class="hljs-constant">Pupa::Model</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>If you would like Pupa.rb to validate your objects, assign to <code>self.schema</code>
an absolute path to a <a href="http://json-schema.org/">JSON Schema</a>. See for
example <a href="https://github.com/opennorth/pupa-ruby/tree/master/schemas/popolo">Popolo’s JSON Schema files</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">self</span>.schema = <span class="hljs-string">'/path/to/json-schema/cat.json'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Adds the <code>created_at</code> and <code>updated_at</code> metadata properties from <a href="http://popoloproject.com/specs/">Popolo</a>.
<code>created_at</code> and <code>updated_at</code> will be set by Pupa.rb before writing to the
database. See <a href="http://rdoc.info/gems/pupa/Pupa/Concerns">Pupa::Concerns</a>
for more mixins.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">include</span> <span class="hljs-constant">Pupa::Concerns::Timestamps</span>

  <span class="hljs-keyword">attr_accessor</span> <span class="hljs-symbol">:image</span>, <span class="hljs-symbol">:name</span>, <span class="hljs-symbol">:breed</span>, <span class="hljs-symbol">:age</span>, <span class="hljs-symbol">:sex</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Declares which properties should be dumped to JSON after a scraping task is
complete. All of these properties will be imported to MongoDB.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dump <span class="hljs-symbol">:image</span>, <span class="hljs-symbol">:name</span>, <span class="hljs-symbol">:breed</span>, <span class="hljs-symbol">:age</span>, <span class="hljs-symbol">:sex</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>When saving an object to the database, Pupa.rb will check if the object had
been saved in a previous run. It uses a “fingerprint” of the object: a
subset of the object’s properties that should uniquely identify the object
within the context of the scraping task. In this case, the image is not an
identifying property, because the image can change without changing the cat.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>fingerprint
    to_h.slice(<span class="hljs-symbol">:name</span>, <span class="hljs-symbol">:breed</span>, <span class="hljs-symbol">:age</span>, <span class="hljs-symbol">:sex</span>)
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Adds a <code>to_s</code> method so that it’s easier to see which objects are being
saved in the processor’s log.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>to_s
    name
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>All processors should inherit from <a href="https://github.com/opennorth/pupa-ruby/blob/master/lib/pupa/processor.rb#files">Pupa::Processor</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CatProcessor</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Pupa::Processor</span></span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>For simple processors like this one, you may put all your code in a generic
<code>scrape_objects</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>scrape_objects</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>The <code>get</code> and <code>post</code> helpers take a URL as a first argument, and a query
string or request body as a second argument.</p>
<p>These methods return the parsed response if the response is HTML, XML or
JSON, and the raw response otherwise.</p>
<p>Responses are by default cached for one day to avoid repeat requests while
developing and testing a processor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    doc = post(<span class="hljs-string">'http://www.iams.ca/en-ca/rescue-pets/pet-finder'</span>,
      <span class="hljs-string">'petName=Cat&amp;petLocation=H2Y 1C6&amp;nextPetSeachFlag=true'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>HTML responses are parsed by <a href="http://nokogiri.org/">Nokogiri</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    doc.css(<span class="hljs-string">'#show-result ul:gt(1)'</span>).each <span class="hljs-keyword">do</span> |row|</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Skips multiple unnamed kittens. Only individual cats!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">next</span> <span class="hljs-keyword">if</span> clean(row.at_css(<span class="hljs-string">'.name'</span>).text) == <span class="hljs-string">'Chatons pour adoption'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Creates a new Cat object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cat = <span class="hljs-constant">Cat</span>.new</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>The <code>clean</code> helper removes extra whitespace from a string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cat.image = row.at_css(<span class="hljs-string">'img'</span>)[<span class="hljs-symbol">:src</span>]
      cat.name = clean(row.at_css(<span class="hljs-string">'.name'</span>).text)
      cat.breed, cat.age, cat.sex =
        clean(row.at_css(<span class="hljs-string">'.features'</span>).text).split(<span class="hljs-string">', '</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Yields the Cat object to the transformation task for processing, e.g.
saving to disk, printing to CSV, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      dispatch(cat)
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Registers a scraping task. This will define an <code>objects</code> method on the
processor, which will return a lazy enumerator of all objects scraped by the
processor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-constant">CatProcessor</span>.add_scraping_task(<span class="hljs-symbol">:objects</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Tells the Pupa command-line parser which processor to use, and then parses
command-line options. Run <code>cat.rb --help</code> to see a full list of options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>runner = <span class="hljs-constant">Pupa::Runner</span>.new(<span class="hljs-constant">CatProcessor</span>)
runner.run(<span class="hljs-constant">ARGV</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Ready to move on? Check out the next example: <a href="http://opennorth.github.io/pupa-ruby/docs/bill.html">bill.rb</a>.</p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
